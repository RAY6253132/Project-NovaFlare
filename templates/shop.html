<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NovaFlare Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #1a1a2e;
            color: white;
            overflow-x: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
            background-image: url('/static/novaflare_bg.png');
        }

        .main-shop-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding-bottom: 5rem; /* Space for the bottom nav bar */
        }

        /* Top Status Bar with Currencies */
        .top-currency-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 20;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .currency-item {
            display: flex;
            align-items: center;
            background: linear-gradient(180deg, #3a3a5e 0%, #2a2a44 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .currency-item img {
            width: 18px;
            height: 18px;
            margin-right: 5px;
        }

        /* Main Shop Content */
        .shop-content {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .shop-section {
            margin-bottom: 2rem;
            background: rgba(42, 42, 68, 0.5);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
        }

        .shop-section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
        }

        .shop-item-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .item-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .item-icon {
            width: 50px;
            height: 50px;
        }

        .item-info h3 {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .buy-button {
            background: linear-gradient(180deg, #e63946 0%, #c42b37 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #9c222e;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .buy-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .cost {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: #ffcc00;
        }
        .cost img {
            width: 20px;
            height: 20px;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 101;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: rgba(42, 42, 68, 0.9);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-btn-confirm {
            background-color: #007BFF;
            color: white;
        }
        .modal-btn-cancel {
            background-color: #e63946;
            color: white;
        }
        
        /* Bottom Navigation Bar */
        .bottom-nav-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0;
            z-index: 100;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: #ccc;
            text-decoration: none;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }
        .nav-item.active {
            color: #007BFF;
        }
        .nav-item-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        /* Global Notification */
        .global-notification {
            position: fixed;
            bottom: 7rem; /* Above bottom nav bar */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 123, 255, 0.9); /* Blue color */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 200;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        .global-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px); /* Slight lift effect */
        }
    </style>
</head>
<body>
    <div class="main-shop-container">
        <div class="top-currency-bar">
            <div class="currency-display">
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='snc_icon.png') }}" alt="Star Night Crystals"> 
                    <span id="snc-count">1000</span>
                </div>
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='lumen_icon.png') }}" alt="Lumen Orbs"> 
                    <span id="lumen-count">0</span>
                </div>
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='halo_icon.png') }}" alt="Halo Orbs"> 
                    <span id="halo-count">0</span>
                </div>
                <div class="currency-item">
                    <img src="https://placehold.co/18x18/FFD700/000000?text=OJ" alt="Orbital Jewels"> 
                    <span id="orbital-jewels-count">0</span>
                </div>
                <div class="currency-item">
                    <img src="https://placehold.co/18x18/FFA07A/000000?text=AC" alt="Auric Crescents"> 
                    <span id="auric-crescents-count">0</span>
                </div>
            </div>
        </div>

        <div class="shop-content">
            <div id="shopContainer">
                <div class="shop-section">
                    <h2 class="shop-section-title">Orb Exchange (Crystals)</h2>
                    <div class="shop-item-list" id="orb-shop-items">
                        <!-- Lumen Orb and Halo Orb items will be dynamically inserted here -->
                    </div>
                </div>

                <div class="shop-section">
                    <h2 class="shop-section-title">Crescents Exchange</h2>
                    <div class="shop-item-list" id="auric-exchange-items">
                        <!-- Auric Crescent items will be dynamically inserted here -->
                    </div>
                </div>

                <div class="shop-section">
                    <h2 class="shop-section-title">Jewel Exchange</h2>
                    <div class="shop-item-list" id="jewel-exchange-items">
                        <!-- Orbital Jewel items will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav-bar">
            <a href="/" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span>Home</span>
            </a>
            <a href="/shop" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                <span>Shop</span>
            </a>
            <a href="/game" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <span>Gacha</span>
            </a>
            <a href="#" class="nav-item" onclick="showDevelopmentMessage('Characters')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>Characters</span>
            </a>
            <a href="#" class="nav-item" onclick="showDevelopmentMessage('Inventory')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-backpack"><path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/><path d="M2 10v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6"/><path d="M10 18v-2a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"/></svg>
                <span>Inventory</span>
            </a>
        </div>
    </div>
    
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <p id="modal-text"></p>
            <div class="modal-buttons">
                <button id="confirm-buy-btn" class="modal-btn modal-btn-confirm">Confirm</button>
                <button onclick="closeModal()" class="modal-btn modal-btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Global Notification Element -->
    <div id="globalNotification" class="global-notification"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.setBackgroundColor('#1a1a2e');
                Telegram.WebApp.setHeaderColor('secondary_bg_color');
                Telegram.WebApp.closeButton.show();
            }
            fetchUserData();
            renderShopItems();
        });

        // Function to show a custom notification (replaces alert)
        function showGlobalNotification(message, duration = 3000) {
            const notification = document.getElementById('globalNotification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function showDevelopmentMessage(featureName) {
            showGlobalNotification(`${featureName} feature is currently in development.`);
        }
        
        function fetchUserData() {
            const initData = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initData : null;
            if (!initData) {
                console.error("Telegram init data is not available.");
                updateCurrencyDisplay({ star_night_crystals: 1000, lumen_orbs: 5, halo_orbs: 0, auric_crescents: 0, orbital_jewels: 0 });
                return;
            }

            fetch('/get_user_data', {
                method: 'GET',
                headers: { 'X-Telegram-Init-Data': initData }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    updateCurrencyDisplay(data);
                } else {
                    console.error("Failed to fetch user data:", data.message);
                    showGlobalNotification(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error("Error fetching user data:", error);
                showGlobalNotification("Network error or server unreachable. Please try again.");
            });
        }

        function updateCurrencyDisplay(data) {
            document.getElementById('snc-count').innerText = data.star_night_crystals;
            document.getElementById('lumen-count').innerText = data.lumen_orbs;
            document.getElementById('halo-count').innerText = data.halo_orbs;
            document.getElementById('auric-crescents-count').innerText = data.auric_crescents;
            document.getElementById('orbital-jewels-count').innerText = data.orbital_jewels; // Update OJ
        }
        
        // Dynamic shop item data (can be fetched from backend)
        const shopItems = {
            'orb_exchange': [ // Combined Lumen and Halo into one section
                { id: 'buy_lumen_1', name: 'Lumen Orb x1', description: 'Standard pull', cost: 70, cost_currency: 'snc_icon.png', icon: 'lumen_icon.png' },
                { id: 'buy_lumen_10', name: 'Lumen Orb x10', description: 'Save 10%', cost: 595, cost_currency: 'snc_icon.png', icon: 'lumen_icon.png' },
                { id: 'buy_halo_1', name: 'Halo Orb x1', description: 'Limited pull', cost: 100, cost_currency: 'snc_icon.png', icon: 'halo_icon.png' },
                { id: 'buy_halo_10', name: 'Halo Orb x10', description: 'Save 10%', cost: 900, cost_currency: 'snc_icon.png', icon: 'halo_icon.png' }
            ],
            'auric_exchange': [
                { id: 'exchange_lumen', name: 'Lumen Orb x1', description: 'Monthly limit: 10', cost: 20, cost_currency: 'auric_crescent_icon.png', icon: 'lumen_icon.png' },
                { id: 'exchange_halo', name: 'Halo Orb x1', description: 'Monthly limit: 10', cost: 20, cost_currency: 'auric_crescent_icon.png', icon: 'halo_icon.png' }
            ],
            'jewel_exchange': [ // New section for Orbital Jewel exchange
                { id: 'exchange_snc_with_oj', name: 'Star Night Crystals x1000', description: 'Exchange 100 Orbital Jewels. Monthly limit: 5', cost: 100, cost_currency: 'orbital_jewels_icon.png', icon: 'snc_icon.png' }
            ]
        };

        function renderShopItems() {
            const orbContainer = document.getElementById('orb-shop-items');
            const auricContainer = document.getElementById('auric-exchange-items');
            const jewelContainer = document.getElementById('jewel-exchange-items');

            orbContainer.innerHTML = shopItems.orb_exchange.map(item => createShopItemHTML(item)).join('');
            auricContainer.innerHTML = shopItems.auric_exchange.map(item => createShopItemHTML(item)).join('');
            jewelContainer.innerHTML = shopItems.jewel_exchange.map(item => createShopItemHTML(item)).join('');
        }

        function createShopItemHTML(item) {
            // Determine the correct image for the item being sold (reward_type icon)
            let itemIconSrc;
            if (item.icon) {
                itemIconSrc = `{{ url_for('static', filename='${item.icon}') }}`;
            } else {
                itemIconSrc = "https://placehold.co/50x50?text=Item"; // Generic fallback
            }

            // Determine the correct image for the cost currency
            let costCurrencyIconSrc;
            if (item.cost_currency === 'orbital_jewels_icon.png') {
                costCurrencyIconSrc = "https://placehold.co/20x20/FFD700/000000?text=OJ"; // Placeholder for OJ
            } else if (item.cost_currency === 'auric_crescent_icon.png') {
                costCurrencyIconSrc = "{{ url_for('static', filename='auric_crescent_icon.png') }}";
            } else if (item.cost_currency === 'snc_icon.png') {
                costCurrencyIconSrc = "{{ url_for('static', filename='snc_icon.png') }}";
            } else {
                costCurrencyIconSrc = "https://placehold.co/20x20?text=Cost"; // Generic fallback
            }


            return `
                <div class="shop-item">
                    <div class="item-details">
                        <img src="${itemIconSrc}" onerror="this.onerror=null;this.src='https://placehold.co/50x50?text=Item';" alt="${item.name}" class="item-icon">
                        <div class="item-info">
                            <h3>${item.name}</h3>
                            <p class="text-sm text-gray-400">${item.description}</p>
                        </div>
                    </div>
                    <button class="buy-button" onclick="showPurchaseModal('${item.id}', '${item.name}', ${item.cost}, '${item.cost_currency}')">
                        <div class="cost">
                            <span>${item.cost}</span>
                            <img src="${costCurrencyIconSrc}" onerror="this.onerror=null;this.src='https://placehold.co/20x20?text=Cost';" alt="Cost">
                        </div>
                    </button>
                </div>
            `;
        }
        
        function showPurchaseModal(itemId, itemName, cost, costCurrency) {
            const modal = document.getElementById('purchaseModal');
            const modalText = document.getElementById('modal-text');
            const confirmBtn = document.getElementById('confirm-buy-btn');

            let currencyName;
            if (costCurrency === 'snc_icon.png') {
                currencyName = 'Star Night Crystals';
            } else if (costCurrency === 'auric_crescent_icon.png') {
                currencyName = 'Auric Crescents';
            } else if (costCurrency === 'orbital_jewels_icon.png') {
                currencyName = 'Orbital Jewels';
            } else {
                currencyName = 'currency'; // Fallback
            }

            modalText.innerText = `Are you sure you want to purchase ${itemName} for ${cost} ${currencyName}?`;
            
            confirmBtn.onclick = () => {
                buyItem(itemId);
                closeModal();
            };
            modal.style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('purchaseModal').style.display = 'none';
        }

        function buyItem(exchangeType) {
            const initData = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initData : null;
            if (!initData) {
                showGlobalNotification("Please open this app inside Telegram to make a purchase.");
                return;
            }

            fetch('/exchange_shop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData
                },
                body: JSON.stringify({ exchange_type: exchangeType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    showGlobalNotification('Purchase successful!');
                    updateCurrencyDisplay(data);
                } else {
                    showGlobalNotification("Purchase failed: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error during purchase:", error);
                showGlobalNotification("An error occurred. Please try again.");
            });
        }
    </script>
</body>
</html>
