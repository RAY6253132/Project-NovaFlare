<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NovaFlare Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #1a1a2e;
            color: white;
            overflow-x: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
            background-image: url('/static/novaflare_bg.png');
        }

        .main-shop-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding-bottom: 5rem; /* Space for the bottom nav bar */
        }

        /* Top Status Bar with Currencies */
        .top-currency-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 20;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .currency-item {
            display: flex;
            align-items: center;
            background: linear-gradient(180deg, #3a3a5e 0%, #2a2a44 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .currency-item img {
            width: 18px;
            height: 18px;
            margin-right: 5px;
        }

        /* Main Shop Content */
        .shop-content {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .shop-section {
            margin-bottom: 2rem;
            background: rgba(42, 42, 68, 0.5);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
        }

        .shop-section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
        }

        .shop-item-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .item-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .item-icon {
            width: 50px;
            height: 50px;
        }

        .item-info h3 {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .buy-button {
            background: linear-gradient(180deg, #e63946 0%, #c42b37 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #9c222e;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .buy-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .cost {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: #ffcc00;
        }
        .cost img {
            width: 20px;
            height: 20px;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 101;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: rgba(42, 42, 68, 0.9);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-btn-confirm {
            background-color: #007BFF;
            color: white;
        }
        .modal-btn-cancel {
            background-color: #e63946;
            color: white;
        }
        
        /* Bottom Navigation Bar */
        .bottom-nav-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0;
            z-index: 100;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: #ccc;
            text-decoration: none;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }
        .nav-item.active {
            color: #007BFF;
        }
        .nav-item-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="main-shop-container">
        <div class="top-currency-bar">
            <div class="currency-display">
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='snc_icon.png') }}" alt="SNC"> 
                    <span id="snc-count">1000</span>
                </div>
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='lumen_icon.png') }}" alt="Lumen"> 
                    <span id="lumen-count">0</span>
                </div>
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='halo_icon.png') }}" alt="Halo"> 
                    <span id="halo-count">0</span>
                </div>
                <div class="currency-item">
                    <img src="{{ url_for('static', filename='auric_crescent_icon.png') }}" alt="Auric"> 
                    <span id="auric-count">0</span>
                </div>
            </div>
        </div>

        <div class="shop-content">
            <div id="shopContainer">
                <div class="shop-section">
                    <h2 class="shop-section-title">Buy Lumen Orbs</h2>
                    <div class="shop-item-list" id="lumen-shop-items">
                        </div>
                </div>

                <div class="shop-section">
                    <h2 class="shop-section-title">Buy Halo Orbs</h2>
                    <div class="shop-item-list" id="halo-shop-items">
                        </div>
                </div>

                <div class="shop-section">
                    <h2 class="shop-section-title">Exchange with Auric Crescents</h2>
                    <div class="shop-item-list" id="exchange-shop-items">
                        </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav-bar">
            <a href="/" class="nav-item">
                <img class="nav-item-icon" src="https://via.placeholder.com/24x24?text=H" alt="Home Icon">
                <span>Home</span>
            </a>
            <a href="/game" class="nav-item">
                <img class="nav-item-icon" src="https://via.placeholder.com/24x24?text=G" alt="Gacha Icon">
                <span>Gacha</span>
            </a>
            <a href="#" class="nav-item" onclick="showDevelopmentMessage('Inventory')">
                <img class="nav-item-icon" src="https://via.placeholder.com/24x24?text=I" alt="Inventory Icon">
                <span>Inventory</span>
            </a>
            <a href="/shop" class="nav-item active">
                <img class="nav-item-icon" src="https://via.placeholder.com/24x24?text=S" alt="Shop Icon">
                <span>Shop</span>
            </a>
        </div>
    </div>
    
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <p id="modal-text"></p>
            <div class="modal-buttons">
                <button id="confirm-buy-btn" class="modal-btn modal-btn-confirm">Confirm</button>
                <button onclick="closeModal()" class="modal-btn modal-btn-cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.setBackgroundColor('#1a1a2e');
                Telegram.WebApp.setHeaderColor('secondary_bg_color');
                Telegram.WebApp.closeButton.show();
            }
            fetchUserData();
            renderShopItems();
        });

        function showDevelopmentMessage(featureName) {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.showAlert(`${featureName} feature is currently in development.`);
            } else {
                alert(`${featureName} feature is currently in development.`);
            }
        }
        
        function fetchUserData() {
            const initData = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initData : null;
            if (!initData) {
                console.error("Telegram init data is not available.");
                updateCurrencyDisplay({ star_night_crystals: 1000, lumen_orbs: 5, halo_orbs: 0, auric_crescents: 0 });
                return;
            }

            fetch('/get_user_data', {
                method: 'GET',
                headers: { 'X-Telegram-Init-Data': initData }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    updateCurrencyDisplay(data);
                } else {
                    console.error("Failed to fetch user data:", data.message);
                }
            })
            .catch(error => console.error("Error fetching user data:", error));
        }

        function updateCurrencyDisplay(data) {
            document.getElementById('snc-count').innerText = data.star_night_crystals;
            document.getElementById('lumen-count').innerText = data.lumen_orbs;
            document.getElementById('halo-count').innerText = data.halo_orbs;
            document.getElementById('auric-count').innerText = data.auric_crescents;
        }
        
        // Dynamic shop item data (can be fetched from backend)
        const shopItems = {
            'lumen': [
                { id: 'buy_lumen_1', name: 'Lumen Orb x1', description: 'Standard pull currency', cost: 70, cost_currency: 'snc_icon.png' },
                { id: 'buy_lumen_10', name: 'Lumen Orb x10', description: 'Save 10%', cost: 595, cost_currency: 'snc_icon.png' }
            ],
            'halo': [
                { id: 'buy_halo_1', name: 'Halo Orb x1', description: 'Limited pull currency', cost: 100, cost_currency: 'snc_icon.png' },
                { id: 'buy_halo_10', name: 'Halo Orb x10', description: 'Save 10%', cost: 900, cost_currency: 'snc_icon.png' }
            ],
            'exchange': [
                { id: 'exchange_lumen', name: 'Lumen Orb x1', description: 'Limited to 10 per month', cost: 20, cost_currency: 'auric_crescent_icon.png' },
                { id: 'exchange_halo', name: 'Halo Orb x1', description: 'Limited to 10 per month', cost: 20, cost_currency: 'auric_crescent_icon.png' }
            ]
        };

        function renderShopItems() {
            const lumenContainer = document.getElementById('lumen-shop-items');
            const haloContainer = document.getElementById('halo-shop-items');
            const exchangeContainer = document.getElementById('exchange-shop-items');

            // Render Lumen items
            lumenContainer.innerHTML = shopItems.lumen.map(item => createShopItemHTML(item)).join('');
            
            // Render Halo items
            haloContainer.innerHTML = shopItems.halo.map(item => createShopItemHTML(item)).join('');

            // Render Exchange items
            exchangeContainer.innerHTML = shopItems.exchange.map(item => createShopItemHTML(item)).join('');
        }

        function createShopItemHTML(item) {
            return `
                <div class="shop-item">
                    <div class="item-details">
                        <img src="{{ url_for('static', filename='${item.cost_currency}') }}" alt="${item.name}" class="item-icon">
                        <div class="item-info">
                            <h3>${item.name}</h3>
                            <p class="text-sm text-gray-400">${item.description}</p>
                        </div>
                    </div>
                    <button class="buy-button" onclick="showPurchaseModal('${item.id}', '${item.name}', ${item.cost}, '${item.cost_currency}')">
                        <div class="cost">
                            <span>${item.cost}</span>
                            <img src="{{ url_for('static', filename='${item.cost_currency}') }}" alt="Cost">
                        </div>
                    </button>
                </div>
            `;
        }
        
        function showPurchaseModal(itemId, itemName, cost, costCurrency) {
            const modal = document.getElementById('purchaseModal');
            const modalText = document.getElementById('modal-text');
            const confirmBtn = document.getElementById('confirm-buy-btn');

            const currencyName = costCurrency === 'snc_icon.png' ? 'Star Night Crystals' : 'Auric Crescents';
            modalText.innerText = `Are you sure you want to purchase ${itemName} for ${cost} ${currencyName}?`;
            
            confirmBtn.onclick = () => {
                buyItem(itemId);
                closeModal();
            };
            modal.style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('purchaseModal').style.display = 'none';
        }

        function buyItem(exchangeType) {
            const initData = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initData : null;
            if (!initData) {
                alert("Please open this app inside Telegram to make a purchase.");
                return;
            }

            fetch('/exchange_shop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData
                },
                body: JSON.stringify({ exchange_type: exchangeType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    if (window.Telegram && window.Telegram.WebApp) {
                        Telegram.WebApp.showAlert('Purchase successful!');
                    }
                    updateCurrencyDisplay(data);
                } else {
                    if (window.Telegram && window.Telegram.WebApp) {
                        Telegram.WebApp.showAlert("Purchase failed: " + data.message);
                    }
                }
            })
            .catch(error => {
                console.error("Error during purchase:", error);
                if (window.Telegram && window.Telegram.WebApp) {
                    Telegram.WebApp.showAlert("An error occurred. Please try again.");
                }
            });
        }
    </script>
</body>
</html>